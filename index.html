<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Invoice Extractor — Upload & Extract</title>
  <meta name="description" content="Invoice Extractor — AI-powered invoice PDF extraction. Amazing UI, theme toggle, AI typing preview."/>
  <style>
    /* ===========================
       THEME / COLOR VARIABLES
       =========================== */
    :root{
      --bg-1: #071027;
      --bg-2: #071a2a;
      --card: rgba(255,255,255,0.03);
      --glass: rgba(255,255,255,0.025);
      --muted: #94a3b8;
      --text: #e6eef8;
      --accent-1: #7c3aed;
      --accent-2: #06b6d4;
      --accent-3: #ff6b6b;
      --success: #10b981;
      --danger: #ef4444;
      --glass-border: rgba(255,255,255,0.03);
      --shadow: 0 12px 40px rgba(2,6,23,0.6);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
      --radius: 12px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color-scheme: dark;
    }

    /* LIGHT THEME OVERRIDES */
    :root.light{
      --bg-1: #f6f9fb;
      --bg-2: #e9f2f7;
      --card: rgba(2,6,23,0.02);
      --glass: rgba(2,6,23,0.02);
      --muted: #475569;
      --text: #071425;
      --glass-border: rgba(2,6,23,0.06);
      --shadow: 0 12px 40px rgba(2,6,23,0.06);
      color-scheme: light;
    }

    /* ===========================
       LAYOUT
       =========================== */
    * { box-sizing: border-box; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    html,body { height:100%; margin:0; background:
      radial-gradient(900px 380px at 15% 10%, rgba(124,58,237,0.06), transparent 8%),
      linear-gradient(180deg,var(--bg-1), var(--bg-2) 60%); color:var(--text); font-size:16px; }

    .app { min-height:100vh; display:flex; align-items:center; justify-content:center; padding:28px; }

    .wrap { width:100%; max-width:1180px; border-radius:18px; padding:22px; background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01)); box-shadow:var(--shadow); border:1px solid var(--glass-border); display:grid; grid-template-columns:360px 1fr; gap:18px; position:relative; overflow:visible; }
    @media (max-width:980px) { .wrap { grid-template-columns: 1fr; padding:16px; } }

    header.top { display:flex; align-items:center; gap:14px; grid-column: 1/-1; margin-bottom:6px; }
    .logo { width:56px; height:56px; border-radius:12px; background: linear-gradient(135deg,var(--accent-1),var(--accent-2)); display:flex; align-items:center; justify-content:center; font-weight:800; color:white; font-size:20px; box-shadow: 0 12px 30px rgba(124,58,237,0.18); }
    .title h1 { margin:0; font-size:20px; letter-spacing: -0.2px; }
    .title p { margin:6px 0 0; color:var(--muted); font-size:13px; }

    .project-note { margin-left:auto; text-align:right; color:var(--muted); font-size:13px; }

    /* ===========================
       LEFT CARD (UPLOAD)
       =========================== */
    .card { background:var(--card); padding:16px; border-radius:var(--radius); border:1px solid var(--glass-border); }
    .drop { border-radius:12px; padding:20px; min-height:200px; display:flex; flex-direction:column; gap:10px; align-items:center; justify-content:center; border:2px dashed rgba(255,255,255,0.04); cursor:pointer; position:relative; transition:all .15s; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00)); }
    .drop.hover { transform: translateY(-6px); border-color: rgba(124,58,237,0.9); box-shadow: 0 36px 90px rgba(7,12,30,0.45); }
    .drop svg { filter: drop-shadow(0 8px 24px rgba(2,6,23,0.55)); }

    .file-info strong { display:block; margin-top:6px; font-size:16px; color:var(--text); }
    .file-info small { color:var(--muted); font-size:13px; }

    .controls { display:flex; gap:10px; margin-top:12px; align-items:center; }
    .btn { padding:10px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:700; transition: transform .12s, box-shadow .12s; }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background: linear-gradient(90deg,var(--accent-1),var(--accent-2)); color:white; box-shadow: 0 10px 30px rgba(6,182,212,0.06); }
    .btn.ghost { background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); }
    .btn.warn { background: linear-gradient(90deg,var(--accent-3),var(--accent-2)); color:white; }

    .progress { height:10px; background: rgba(255,255,255,0.02); border-radius:999px; overflow:hidden; margin-top:12px; }
    .bar { height:100%; width:0%; background: linear-gradient(90deg,var(--accent-2),var(--accent-1)); transition: width .18s; }

    .meta { display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
    .chip { background: rgba(255,255,255,0.02); padding:8px 10px; border-radius:999px; font-size:13px; color:var(--muted); }

    /* ===========================
       RIGHT COLUMN (RESULTS)
       =========================== */
    .right { display:flex; flex-direction:column; gap:12px; }
    .panel { background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01)); padding:14px; border-radius:12px; border:1px solid rgba(255,255,255,0.03); box-shadow: 0 8px 30px rgba(2,6,23,0.35); }

    .fields { display:flex; gap:12px; flex-wrap:wrap; margin-top:10px; }
    .field { min-width:180px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00)); padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.02); transition: transform .15s, box-shadow .15s; }
    .field:hover { transform: translateY(-6px); box-shadow: 0 16px 36px rgba(2,6,23,0.45); }
    .field h4 { margin:0; font-size:12px; color:var(--muted); }
    .field p { margin:8px 0 0; font-size:18px; font-weight:800; color:var(--text); }

    /* AI typing preview (single raw box) */
    .ai-typing { font-family: var(--mono); white-space: pre-wrap; font-size:14px; line-height:1.5; color:var(--text); min-height:140px; border-radius:10px; padding:14px; background: linear-gradient(180deg, rgba(0,0,0,0.18), rgba(255,255,255,0.02)); border:1px solid rgba(255,255,255,0.02); overflow:auto; }
    .ai-typing .line { display:block; margin-bottom:8px; opacity:0; transform: translateY(6px); transition: all .22s ease; }

    .result { background: #041323; padding:12px; border-radius:10px; color:#dbeafe; white-space: pre-wrap; max-height:420px; overflow:auto; font-family: var(--mono); font-size:13px; border:1px solid rgba(255,255,255,0.03); }

    footer.small { color:var(--muted); font-size:13px; }

    /* theme toggle */
    .toggle { display:inline-flex; align-items:center; gap:8px; padding:8px; border-radius:999px; background: rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); cursor:pointer; }
    .toggle svg { filter: drop-shadow(0 6px 20px rgba(2,6,23,0.45)); }

    /* confetti canvas */
    #confetti { position: fixed; left:0; top:0; width:100%; height:100%; pointer-events:none; z-index:9999; }

    /* success/failure animations */
    .status-success { animation: successPulse .9s ease both; }
    @keyframes successPulse { 0%{ transform: translateY(0) scale(1) } 50%{ transform: translateY(-6px) scale(1.02) } 100%{ transform: translateY(0) scale(1) } }

    .status-fail { animation: failShake .6s ease both; }
    @keyframes failShake { 0%{ transform: translateX(0) } 25%{ transform: translateX(-6px) } 50%{ transform: translateX(6px) } 75%{ transform: translateX(-6px) } 100%{ transform: translateX(0) } }

    /* caret for typing */
    .caret { display:inline-block; width:10px; animation: blink 1s steps(2) infinite; }
    @keyframes blink { 0%{opacity:1} 50%{opacity:0} 100%{opacity:1} }

    /* responsive */
    @media (max-width:520px) {
      .fields { gap:8px; }
      .logo { width:48px; height:48px; font-size:18px; }
      .drop { min-height:160px; }
      .field { min-width:140px; }
      .ai-typing { font-size:13px; min-height:120px; }
    }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Invoice Extractor">
    <div class="wrap" id="wrap">

      <!-- Header -->
      <header class="top" role="banner">
        <div style="display:flex;align-items:center;gap:12px">
          <div class="logo" aria-hidden>IE</div>
          <div class="title">
            <h1>Invoice Extractor — Upload & Extract</h1>
            <p>Select or drag a PDF invoice. Result shows below. Connected to your hosted backend.</p>
          </div>
        </div>
        <div class="project-note">
          <div style="font-weight:700">LLM Agent • Render-hosted</div>
          <div style="margin-top:6px;color:var(--muted);font-size:13px">PDF parsing + optional LLM refinement. Smooth animations, typewriter AI preview and accessible controls.</div>
        </div>
      </header>

      <!-- LEFT: Upload panel -->
      <div>
        <div class="card" role="region" aria-label="Upload PDF">
          <div id="drop" class="drop" tabindex="0">
            <svg width="58" height="58" viewBox="0 0 24 24" fill="none" aria-hidden>
              <path d="M12 3v9" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M8 7l4-4 4 4" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <div class="file-info" aria-live="polite">
              <strong id="fileName">Click or drop PDF here</strong>
              <small>Supports single PDF. Max size depends on your server.</small>
            </div>
            <input id="fileInput" type="file" accept="application/pdf" style="display:none" aria-hidden="true" />
          </div>

          <div class="controls">
            <button id="uploadBtn" class="btn primary" aria-label="Upload and extract">Upload & Extract</button>
            <button id="clearBtn" class="btn ghost" aria-label="Clear">Clear</button>

            <div style="flex:1"></div>

            <div id="themeToggle" class="toggle" role="button" aria-pressed="false" aria-label="Toggle theme">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" stroke="white" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              <div style="font-size:13px;color:var(--muted)">Theme</div>
            </div>
          </div>

          <div class="progress" aria-hidden="true"><div id="bar" class="bar" style="width:0%"></div></div>

          <div class="meta" aria-hidden="true">
            <div class="chip">Status: <span id="status">Idle</span></div>
            <div class="chip">Last file: <span id="lastFile">—</span></div>
            <div class="chip">Bytes received: <span id="bytes">0</span></div>
          </div>

          <div style="margin-top:12px;color:var(--muted);font-size:13px">
            Endpoint:
            <div style="word-break:break-all;margin-top:6px"><strong id="endpointDisplay" style="color:var(--accent-2)"></strong></div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Results -->
      <div class="right" role="region" aria-label="Results">
        <div class="panel" style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
          <div>
            <div style="color:var(--muted)">Invoice summary</div>
            <h2 style="margin:6px 0 0">Extracted fields</h2>
            <div style="margin-top:6px;color:var(--muted);font-size:13px">Results are shown below. If you see a CORS error, ensure the backend allows requests from your frontend origin.</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
            <div style="font-size:13px;color:var(--muted)">LLM: <strong id="llmProvider">—</strong></div>
            <div style="display:flex;gap:8px">
              <a id="downloadJson" class="btn ghost" href="#" download="invoice.json" aria-label="Download extracted JSON">Download JSON</a>
              <button id="copyBtn" class="btn ghost" aria-label="Copy JSON">Copy JSON</button>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="fields" id="fieldsArea">
            <div class="field"><h4>Invoice Number</h4><p id="invNum">—</p></div>
            <div class="field"><h4>Invoice Date</h4><p id="invDate">—</p></div>
            <div class="field"><h4>Total Amount</h4><p id="invTotal">—</p></div>
          </div>
        </div>

        <div class="panel">
          <h4 style="margin:0 0 8px">AI typing preview</h4>
          <div id="aiTyping" class="ai-typing" aria-live="polite">No data yet <span class="caret">▍</span></div>
          <footer class="small" style="margin-top:8px;color:var(--muted)">The preview types the raw extracted data line-by-line like an AI assistant.</footer>
        </div>

        <div class="panel">
          <h4 style="margin:0 0 8px">Raw / full extracted content (JSON)</h4>
          <pre id="result" class="result">No data yet</pre>
        </div>
      </div>

      <!-- confetti canvas -->
      <canvas id="confetti"></canvas>

    </div>
  </div>

  <script>
  /***************************************************************************
   * CONFIG: set your backend endpoint here (HTTPS recommended)
   * Make sure your Flask backend CORS allows your frontend origin.
   ***************************************************************************/
  const BACKEND_URL = "https://invoice-extractor-2-835j.onrender.com/extract";
  document.getElementById('endpointDisplay').textContent = BACKEND_URL;

  /***************************************************************************
   * UI ELEMENTS
   ***************************************************************************/
  const drop = document.getElementById('drop');
  const fileInput = document.getElementById('fileInput');
  const uploadBtn = document.getElementById('uploadBtn');
  const clearBtn = document.getElementById('clearBtn');
  const fileNameEl = document.getElementById('fileName');
  const statusEl = document.getElementById('status');
  const bar = document.getElementById('bar');
  const lastFileEl = document.getElementById('lastFile');
  const bytesEl = document.getElementById('bytes');
  const resultEl = document.getElementById('result');
  const invNumEl = document.getElementById('invNum');
  const invDateEl = document.getElementById('invDate');
  const invTotalEl = document.getElementById('invTotal');
  const aiTyping = document.getElementById('aiTyping');
  const llmProviderEl = document.getElementById('llmProvider');
  const downloadJson = document.getElementById('downloadJson');
  const copyBtn = document.getElementById('copyBtn');
  const themeToggle = document.getElementById('themeToggle');
  const confettiCanvas = document.getElementById('confetti');

  let currentFile = null;
  let lastJson = null;
  let abortTyping = false;

  /***************************************************************************
   * Drag & drop, file selection
   ***************************************************************************/
  drop.addEventListener('click', () => fileInput.click());
  drop.addEventListener('dragover', (e) => { e.preventDefault(); drop.classList.add('hover'); });
  drop.addEventListener('dragleave', () => { drop.classList.remove('hover'); });
  drop.addEventListener('drop', (e) => {
    e.preventDefault(); drop.classList.remove('hover');
    const f = e.dataTransfer.files && e.dataTransfer.files[0];
    if (f) selectFile(f);
  });

  fileInput.addEventListener('change', (e) => {
    if (e.target.files && e.target.files[0]) selectFile(e.target.files[0]);
  });

  function selectFile(file) {
    if (!file) return;
    if (file.type !== "application/pdf") { alert("Please select a PDF file."); return; }
    currentFile = file;
    fileNameEl.textContent = file.name;
    lastFileEl.textContent = file.name;
    bytesEl.textContent = file.size.toLocaleString() + " bytes";
  }

  clearBtn.addEventListener('click', () => {
    currentFile = null;
    fileNameEl.textContent = "Click or drop PDF here";
    resultEl.textContent = "No data yet";
    invNumEl.textContent = "—";
    invDateEl.textContent = "—";
    invTotalEl.textContent = "—";
    aiTyping.textContent = "No data yet ▍";
    statusEl.textContent = "Idle";
    bar.style.width = "0%";
    lastJson = null;
    downloadJson.href = "#";
  });

  uploadBtn.addEventListener('click', async () => {
    if (!currentFile) return alert("Please select a PDF file first.");
    await uploadFile(currentFile);
  });

  /***************************************************************************
   * Upload with progress using XMLHttpRequest (to show progress reliably)
   ***************************************************************************/
  function uploadFile(file) {
    return new Promise((resolve) => {
      const xhr = new XMLHttpRequest();
      const fd = new FormData();
      fd.append('file', file);

      xhr.open('POST', BACKEND_URL, true);

      xhr.upload.onprogress = (e) => {
        if (e.lengthComputable) {
          const pct = Math.round((e.loaded / e.total) * 100);
          bar.style.width = pct + "%";
          statusEl.textContent = `Uploading ${pct}%`;
        }
      };

      xhr.onload = () => {
        if (xhr.status >= 200 && xhr.status < 300) {
          statusEl.textContent = "Done";
          bar.style.width = "100%";
          let json;
          try {
            json = JSON.parse(xhr.responseText);
          } catch (err) {
            resultEl.textContent = "Invalid JSON response from server:\n" + xhr.responseText;
            console.error("Invalid JSON response", err);
            return resolve();
          }
          handleResult(json);
          return resolve(json);
        } else {
          statusEl.textContent = `Error ${xhr.status}`;
          resultEl.textContent = `Server returned status ${xhr.status}\n\n${xhr.responseText}`;
          console.error("Server returned error", xhr.status, xhr.responseText);
          // show provider if available
          try {
            const obj = JSON.parse(xhr.responseText || "{}");
            if (obj.llm_provider) setLLM(obj.llm_provider);
          } catch (e) {}
          animateFailure();
          return resolve();
        }
      };

      xhr.onerror = () => {
        statusEl.textContent = "Network error";
        resultEl.textContent = "Network or CORS error. Check browser console for details.";
        console.error("XHR network error", xhr);
        animateFailure();
        return resolve();
      };

      statusEl.textContent = "Starting upload...";
      setTimeout(() => xhr.send(fd), 120);
    });
  }

  /***************************************************************************
   * Handle backend JSON result (many backend shapes handled)
   ***************************************************************************/
  function handleResult(json) {
    // Keep last JSON for download/copy
    lastJson = json;
    downloadJson.href = URL.createObjectURL(new Blob([JSON.stringify(json, null, 2)], {type: 'application/json'}));
    resultEl.textContent = JSON.stringify(json, null, 2);

    // Set LLM provider display
    setLLM(json.llm_provider || json.provider || json.llm_provider || "none");

    // Some backends may return 'llm_parsed', 'parsed', 'parsed_basic'
    const parsed = json.llm_parsed || json.parsed || json.parsed_basic || json.parsed_basic || null;

    // If parsed object is null, try to infer from raw_text or content
    const rawText = (json.raw_text || json.content || json.extracted_data || json.content || "").toString();

    // Clear typing
    abortTyping = true;

    // If we have a parsed object, extract fields
    if (parsed && typeof parsed === 'object') {
      invNumEl.textContent = parsed.invoice_number || parsed.invoiceNum || parsed.invoice || parsed.invoice_no || parsed.invoice_number_raw || "—";
      invDateEl.textContent = parsed.invoice_date || parsed.date || parsed.invoiceDate || "—";
      invTotalEl.textContent = parsed.total_amount || parsed.total || parsed.amount || parsed.grand_total || "—";
      // show typing of raw_text if available, else pretty print parsed as text lines
      const rawForTyping = rawText || prettifyParsed(parsed);
      startTypingPreview(rawForTyping);
      animateSuccess();
      return;
    }

    // Fallback: try to find simple fields from parsed_basic or rawText heuristics
    if (json.parsed_basic && typeof json.parsed_basic === 'object') {
      invNumEl.textContent = json.parsed_basic.invoice_number || "—";
      invDateEl.textContent = json.parsed_basic.invoice_date || "—";
      invTotalEl.textContent = json.parsed_basic.total_amount || "—";
      const rawForTyping = rawText || JSON.stringify(json.parsed_basic, null, 2);
      startTypingPreview(rawForTyping);
      animateSuccess();
      return;
    }

    // If nothing structured, still show rawText in typing preview
    if (rawText && rawText.trim().length > 0) {
      invNumEl.textContent = "—";
      invDateEl.textContent = "—";
      invTotalEl.textContent = "—";
      startTypingPreview(rawText);
      animateSuccess();
      return;
    }

    // Nothing: failure
    aiTyping.textContent = "No data received — check backend logs and CORS.";
    animFailureSmall();
  }

  function prettifyParsed(parsed) {
    try {
      return Object.entries(parsed).map(([k,v]) => `${k}: ${JSON.stringify(v)}`).join("\n");
    } catch (e) {
      return JSON.stringify(parsed, null, 2);
    }
  }

  function setLLM(name) {
    if (!name) name = "none";
    llmProviderEl.textContent = String(name);
  }

  /***************************************************************************
   * Typing preview: types the raw content line by line to look like AI typing
   * - configurable speeds
   * - supports abort (for subsequent uploads)
   ***************************************************************************/
  const typingConfig = {
    lineDelay: 180,      // delay between lines appearing (ms)
    charDelay: 14,       // char typing speed (ms)
    punctuationBoost: 30 // slower on punctuation
  };

  async function startTypingPreview(text) {
    // Normalize text to lines
    abortTyping = false;
    aiTyping.innerHTML = "";
    // split into lines but keep paragraphs: split on \n
    const rawLines = text.split(/\r?\n/).filter(Boolean);
    if (rawLines.length === 0) {
      // If no lines, print as single line gradually
      await typeLine(text);
      return;
    }
    for (let i = 0; i < rawLines.length; i++) {
      if (abortTyping) return;
      const line = rawLines[i].trim();
      if (!line) {
        // blank line gap
        await sleep(typingConfig.lineDelay);
        continue;
      }
      // create element for line
      const span = document.createElement('div');
      span.className = "line";
      aiTyping.appendChild(span);

      // reveal with fade/translate
      requestAnimationFrame(() => {
        span.style.opacity = 1;
        span.style.transform = "translateY(0)";
      });

      // type text into span
      await typeCharacters(span, line);
      // small delay between lines
      await sleep(typingConfig.lineDelay + Math.min(200, line.length * 3));
    }
    // Add caret at end
    const caret = document.createElement('span');
    caret.className = "caret";
    caret.textContent = "▍";
    aiTyping.appendChild(caret);
  }

  async function typeLine(text) {
    const div = document.createElement('div');
    div.className = "line";
    aiTyping.appendChild(div);
    await typeCharacters(div, text);
  }

  function sleep(ms) {
    return new Promise(r => setTimeout(r, ms));
  }

  async function typeCharacters(container, text) {
    container.textContent = "";
    for (let i = 0; i < text.length; i++) {
      if (abortTyping) return;
      const ch = text[i];
      container.textContent += ch;
      // speed variation for punctuation
      const extra = /[,.!?;:]/.test(ch) ? typingConfig.punctuationBoost : 0;
      await sleep(typingConfig.charDelay + extra);
    }
  }

  /***************************************************************************
   * Animations: success (confetti) + failure
   ***************************************************************************/
  function animateSuccess() {
    statusEl.textContent = "Done";
    // small pulse
    uploadBtn.classList.add('status-success');
    setTimeout(() => uploadBtn.classList.remove('status-success'), 900);
    // confetti
    fireConfetti();
  }

  function animateFailure() {
    statusEl.textContent = "Failed";
    uploadBtn.classList.add('status-fail');
    setTimeout(() => uploadBtn.classList.remove('status-fail'), 800);
  }

  function animFailureSmall() {
    statusEl.textContent = "Idle";
    uploadBtn.classList.add('status-fail');
    setTimeout(() => uploadBtn.classList.remove('status-fail'), 600);
  }

  /***************************************************************************
   * Confetti implementation (lightweight)
   * - simple confetti for success
   ***************************************************************************/
  (function initConfetti(){
    const canvas = confettiCanvas;
    const ctx = canvas.getContext('2d');
    let width = 0, height = 0, active = false;
    let particles = [];

    function resize() {
      width = canvas.width = window.innerWidth;
      height = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    function rand(min, max) { return Math.random()*(max-min)+min; }
    function createParticles(count=80) {
      particles = [];
      for (let i=0;i<count;i++){
        particles.push({
          x: rand(0, width),
          y: rand(-height*0.2, height*0.6),
          vx: rand(-6,6),
          vy: rand(2,10),
          size: rand(6,14),
          color: randomColor()
        });
      }
    }
    function randomColor(){
      const palette = [getComputedStyle(document.documentElement).getPropertyValue('--accent-1').trim() || '#7c3aed', getComputedStyle(document.documentElement).getPropertyValue('--accent-2').trim() || '#06b6d4', '#ffd166', '#ff6b6b'];
      return palette[Math.floor(Math.random()*palette.length)];
    }
    function draw() {
      ctx.clearRect(0,0,width,height);
      for (let p of particles){
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.ellipse(p.x,p.y,p.size,p.size*0.6,Math.random(),0,Math.PI*2);
        ctx.fill();
      }
    }
    function step() {
      for (let p of particles){
        p.x += p.vx;
        p.y += p.vy;
        p.vy *= 1.01;
        p.vx *= 0.99;
      }
      // remove offscreen
      particles = particles.filter(p => p.y < height + 60);
      draw();
      if (particles.length > 0) requestAnimationFrame(step);
      else { active = false; ctx.clearRect(0,0,width,height); }
    }
    window.fireConfetti = function() {
      createParticles(70);
      if (!active) { active = true; step(); }
    };
  })();

  /***************************************************************************
   * Theme toggle logic (ensures readable color contrast on all elements)
   ***************************************************************************/
  (function themeInit(){
    const root = document.documentElement;
    // check saved preference
    const saved = localStorage.getItem('ie_theme');
    if (saved === 'light') root.classList.add('light');
    themeToggle.addEventListener('click', () => {
      root.classList.toggle('light');
      const isLight = root.classList.contains('light');
      themeToggle.setAttribute('aria-pressed', String(isLight));
      localStorage.setItem('ie_theme', isLight ? 'light' : 'dark');
      // tiny micro-interaction
      themeToggle.animate([{ transform: 'scale(0.98)' }, { transform: 'scale(1.02)' }, { transform: 'scale(1)' }], { duration: 280, easing: 'ease' });
    });
  })();

  /***************************************************************************
   * Copy / Download JSON buttons
   ***************************************************************************/
  copyBtn.addEventListener('click', async () => {
    if (!lastJson) return alert("No extracted JSON to copy.");
    try {
      await navigator.clipboard.writeText(JSON.stringify(lastJson, null, 2));
      copyBtn.textContent = "Copied ✓";
      setTimeout(() => copyBtn.textContent = "Copy JSON", 1500);
    } catch (e) {
      alert("Failed to copy: " + e.message);
    }
  });

  /***************************************************************************
   * Small helper: console safety, show backend health on load
   ***************************************************************************/
  (async function checkBackend() {
    try {
      const res = await fetch(BACKEND_URL.replace(/\/extract$/, '/'), { method: 'GET' });
      if (res.ok) {
        const txt = await res.text().catch(()=>null);
        // If backend returns plain string or JSON, don't clobber UI
        console.info("Backend root:", txt || "OK");
      } else {
        console.warn("Backend root returned status", res.status);
      }
    } catch (e) {
      console.warn("Could not reach backend root:", e.message);
      // Do not break UX; this will be handled on upload attempt
    }
  })();

  /***************************************************************************
   * Small utility: graceful fallback for older browsers to avoid uncaught errors
   ***************************************************************************/
  window.addEventListener('error', (e) => {
    console.warn("Client error:", e.message, e.filename, e.lineno);
  });

  /***************************************************************************
   * Extra: keyboard accessibility for drop area (enter = open file selector)
   ***************************************************************************/
  drop.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') {
      fileInput.click();
      e.preventDefault();
    }
  });

  /***************************************************************************
   * END SCRIPT
   ***************************************************************************/
  </script>
</body>
</html>
