<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Invoice Extractor — Upload</title>
  <meta name="description" content="Invoice Extractor — upload a PDF, extract fields, nice UI." />
  <style>
    /* ===== THEME: Violet-Blue Neon (desktop-focused, responsive) ===== */
    :root{
      --bg-1:#050812; --bg-2:#071327;
      --card: rgba(255,255,255,0.03);
      --muted:#97a9c0;
      --accent1:#7c3aed; /* violet */
      --accent2:#06b6d4; /* cyan */
      --neon: linear-gradient(90deg,var(--accent1),var(--accent2));
      --success:#10b981; --danger:#ef4444;
      --glass: rgba(255,255,255,0.02);
      --shadow: 0 20px 60px rgba(2,6,23,0.65);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    }
    :root.light {
      --bg-1:#f6f9fb; --bg-2:#e9f5fb;
      --card: rgba(2,6,23,0.02);
      --muted:#475569;
      --shadow: 0 20px 50px rgba(2,6,23,0.06);
    }

    html,body{height:100%;margin:0;background:
      radial-gradient(700px 300px at 10% 10%, rgba(124,58,237,0.06), transparent 6%),
      linear-gradient(180deg,var(--bg-1),var(--bg-2) 65%); color:#e6eef8; -webkit-font-smoothing:antialiased;}
    .app{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px}

    /* Container */
    .wrap{width:100%;max-width:1150px;border-radius:16px;padding:18px;display:grid;grid-template-columns:380px 1fr;gap:18px;
      background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));box-shadow:var(--shadow);border:1px solid var(--glass)}
    @media(max-width:980px){.wrap{grid-template-columns:1fr;padding:14px}}

    /* Header */
    header{display:flex;align-items:center;gap:14px;margin-bottom:12px;grid-column:1/-1}
    .logo{width:56px;height:56px;border-radius:12px;background:var(--neon);display:flex;align-items:center;justify-content:center;font-weight:800;color:white;box-shadow:0 12px 40px rgba(124,58,237,0.18)}
    h1{margin:0;font-size:20px}
    .lead{margin:0;color:var(--muted);font-size:13px}

    /* Left card (upload) */
    .card{background:var(--card);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .drop{border-radius:12px;padding:20px;min-height:210px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;border:2px dashed rgba(255,255,255,0.04);cursor:pointer;transition:transform .12s, border-color .12s}
    .drop.hover{transform:translateY(-6px);border-color: rgba(124,58,237,0.9)}
    .drop svg{filter:drop-shadow(0 10px 36px rgba(6,182,212,0.08))}

    .controls{display:flex;gap:10px;margin-top:12px}
    .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--neon);color:white}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}

    .progress{height:10px;background:rgba(255,255,255,0.02);border-radius:999px;overflow:hidden;margin-top:12px}
    .bar{height:100%;width:0%;background:linear-gradient(90deg,#ff6b6b,#ffd166,#06b6d4);transition:width .18s}

    .meta{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .chip{background:rgba(255,255,255,0.02);padding:8px 10px;border-radius:999px;font-size:13px;color:var(--muted)}

    /* Right column: results */
    .right{display:flex;flex-direction:column;gap:12px}
    .fields{display:flex;gap:12px;flex-wrap:wrap}
    .field{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));padding:12px;border-radius:10px;min-width:160px;border:1px solid rgba(255,255,255,0.02)}
    .field h4{margin:0;font-size:12px;color:var(--muted)}
    .field p{margin:6px 0 0;font-size:16px;font-weight:700;color:#e6eef8}

    pre.result{background:#041323;padding:16px;border-radius:10px;color:#dbeafe;white-space:pre-wrap;max-height:440px;overflow:auto;border:1px solid rgba(255,255,255,0.03);font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;font-size:13px}

    .ai-preview{background:transparent;padding:14px;border-radius:10px;border:1px dashed rgba(255,255,255,0.03);min-height:120px;font-family: ui-monospace, monospace;color:#e6eef8}

    footer.small{color:var(--muted);font-size:13px}

    /* Theme toggle */
    .toggle{display:inline-flex;align-items:center;gap:8px;padding:8px;border-radius:999px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);cursor:pointer}

    /* subtle micro interactions */
    .field:hover{transform:translateY(-6px);transition:transform .18s}
    .link-animated{color:var(--accent2); text-decoration:none; position:relative}
    .link-animated::after{content:'';position:absolute;left:0;right:0;height:2px;background:var(--accent2);bottom:-2px;transform:scaleX(0);transform-origin:left;transition:transform .18s}
    .link-animated:hover::after{transform:scaleX(1)}

    @media(max-width:900px){ .wrap{grid-template-columns:1fr} .logo{width:48px;height:48px} .drop{min-height:160px} }
  </style>
</head>
<body>
  <div class="app">
    <div class="wrap" id="wrap">
      <header>
        <div style="display:flex;gap:12px;align-items:center">
          <div class="logo">IE</div>
          <div>
            <h1>Invoice Extractor — Upload & Extract</h1>
            <p class="lead">Drag or click to upload a PDF. Results appear here. Backend must accept POST /extract</p>
          </div>
        </div>

        <div style="margin-left:auto;display:flex;gap:12px;align-items:center">
          <div class="toggle" id="themeToggle" title="Toggle light / dark">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 3v1" stroke="white" stroke-width="1.6" stroke-linecap="round"/></svg>
            <div style="font-size:13px;color:var(--muted)">Theme</div>
          </div>
        </div>
      </header>

      <!-- LEFT: upload -->
      <div>
        <div class="card">
          <div id="drop" class="drop" tabindex="0" role="button" aria-label="Drop PDF">
            <svg width="58" height="58" viewBox="0 0 24 24" fill="none" aria-hidden>
              <path d="M12 3v9" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M8 7l4-4 4 4" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <div style="text-align:center">
              <strong id="fileName">Click or drop PDF here</strong>
              <div style="color:var(--muted);font-size:13px;margin-top:6px">Supports single PDF. Max size depends on your server.</div>
            </div>
            <input id="fileInput" type="file" accept="application/pdf" style="display:none" />
          </div>

          <div class="controls">
            <button id="uploadBtn" class="btn primary">Upload & Extract</button>
            <button id="clearBtn" class="btn ghost">Clear</button>
            <div style="flex:1"></div>
            <div style="font-size:13px;color:var(--muted)">Endpoint: <span id="endpointDisplay" style="color:var(--accent2)"></span></div>
          </div>

          <div class="progress"><div id="bar" class="bar" style="width:0%"></div></div>

          <div class="meta" style="margin-top:10px">
            <div class="chip">Status: <span id="status">Idle</span></div>
            <div class="chip">Last file: <span id="lastFile">—</span></div>
            <div class="chip">Bytes: <span id="bytes">0</span></div>
          </div>
        </div>
      </div>

      <!-- RIGHT: results -->
      <div class="right">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <h3 style="margin:0">Extracted fields</h3>
              <div style="color:var(--muted);font-size:13px;margin-top:6px">Basic parsed fields from invoice (attempts to parse common patterns).</div>
            </div>
            <div style="display:flex;gap:8px">
              <button id="copyBtn" class="btn ghost">Copy JSON</button>
              <a id="downloadJson" class="btn ghost" href="#" download="invoice.json">Download</a>
            </div>
          </div>

          <div class="fields" style="margin-top:12px">
            <div class="field"><h4>Invoice Number</h4><p id="invNum">—</p></div>
            <div class="field"><h4>Invoice Date</h4><p id="invDate">—</p></div>
            <div class="field"><h4>Total Amount</h4><p id="invTotal">—</p></div>
          </div>
        </div>

        <div class="card">
          <h4 style="margin:0 0 8px">AI typing preview (raw extracted content)</h4>
          <div id="aiPreview" class="ai-preview">No data yet</div>
        </div>

        <div class="card">
          <h4 style="margin:0 0 8px">Full extracted / LLM response</h4>
          <pre id="result" class="result">No data yet</pre>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ===== CONFIG =====
       Set your backend URL here (must be HTTPS for deployed static site)
    */
    const BACKEND_URL = "https://invoice-extractor-2-835j.onrender.com/extract"; // <-- change this if needed
    document.getElementById('endpointDisplay').textContent = BACKEND_URL;

    /* ===== ELEMENTS ===== */
    const drop = document.getElementById('drop');
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const clearBtn = document.getElementById('clearBtn');
    const fileNameEl = document.getElementById('fileName');
    const statusEl = document.getElementById('status');
    const bar = document.getElementById('bar');
    const lastFileEl = document.getElementById('lastFile');
    const bytesEl = document.getElementById('bytes');
    const resultEl = document.getElementById('result');
    const invNumEl = document.getElementById('invNum');
    const invDateEl = document.getElementById('invDate');
    const invTotalEl = document.getElementById('invTotal');
    const aiPreview = document.getElementById('aiPreview');
    const copyBtn = document.getElementById('copyBtn');
    const downloadJson = document.getElementById('downloadJson');
    const themeToggle = document.getElementById('themeToggle');

    let currentFile = null;
    let lastJson = null;

    /* Drag & click handlers */
    drop.addEventListener('click', () => fileInput.click());
    drop.addEventListener('dragover', (e) => { e.preventDefault(); drop.classList.add('hover'); });
    drop.addEventListener('dragleave', () => drop.classList.remove('hover'));
    drop.addEventListener('drop', (e) => { e.preventDefault(); drop.classList.remove('hover'); const f = e.dataTransfer.files && e.dataTransfer.files[0]; if (f) selectFile(f); });
    fileInput.addEventListener('change', (e) => { if (e.target.files && e.target.files[0]) selectFile(e.target.files[0]); });

    function selectFile(file){
      if (file.type !== "application/pdf") { alert("Please select a PDF file."); return; }
      currentFile = file;
      fileNameEl.textContent = file.name;
      lastFileEl.textContent = file.name;
      bytesEl.textContent = file.size.toLocaleString() + " bytes";
      statusEl.textContent = "Ready";
    }

    clearBtn.addEventListener('click', () => {
      currentFile = null;
      fileNameEl.textContent = "Click or drop PDF here";
      resultEl.textContent = "No data yet";
      invNumEl.textContent = "—"; invDateEl.textContent = "—"; invTotalEl.textContent = "—";
      aiPreview.textContent = "No data yet";
      statusEl.textContent = "Idle";
      bar.style.width = "0%";
      lastJson = null;
      downloadJson.href = "#";
    });

    uploadBtn.addEventListener('click', async () => {
      if (!currentFile) return alert("Please select a PDF first.");
      await uploadFile(currentFile);
    });

    /* ===== Upload with progress (XHR) ===== */
    function uploadFile(file){
      return new Promise((resolve) => {
        const xhr = new XMLHttpRequest();
        const fd = new FormData();
        fd.append('file', file);
        xhr.open('POST', BACKEND_URL, true);
        xhr.upload.onprogress = (e) => {
          if (e.lengthComputable) {
            const pct = Math.round((e.loaded / e.total) * 100);
            bar.style.width = pct + "%";
            statusEl.textContent = `Uploading ${pct}%`;
          }
        };
        xhr.onload = () => {
          if (xhr.status >= 200 && xhr.status < 300) {
            try {
              const json = JSON.parse(xhr.responseText);
              statusEl.textContent = "Done";
              bar.style.width = "100%";
              handleResult(json);
              return resolve(json);
            } catch (err) {
              resultEl.textContent = "Invalid JSON response:\n" + xhr.responseText;
              console.error("Invalid JSON", err);
              return resolve();
            }
          } else {
            statusEl.textContent = `Error ${xhr.status}`;
            resultEl.textContent = `Server returned status ${xhr.status}\n\n${xhr.responseText}`;
            console.error("Server error:", xhr.status, xhr.responseText);
            return resolve();
          }
        };
        xhr.onerror = () => {
          statusEl.textContent = "Network error";
          resultEl.textContent = "Network or CORS error. Check console for details.";
          console.error("Network/CORS error (fetch/XHR). If CORS, add Access-Control-Allow-Origin on backend.");
          return resolve();
        };
        statusEl.textContent = "Starting upload...";
        setTimeout(() => xhr.send(fd), 150); // slight delay so UX shows progress
      });
    }

    /* ===== Handle backend response =====
       Accepts shapes like:
         { content: "...", message: "...", parsed_basic: {...}, llm_parsed: {...}, raw_text: "...", llm_provider: "groq" }
    */
    function handleResult(json){
      lastJson = json;
      resultEl.textContent = JSON.stringify(json, null, 2);

      // Show provider if present
      if (json.llm_provider) {
        // don't clutter UI; put provider to console
        console.info("LLM provider:", json.llm_provider);
      }

      // Prefer structured parsed data if available
      const parsed = json.llm_parsed || json.parsed || json.parsed_basic || null;

      // Fill fields from parsed or fallback to heuristics over text/content
      if (parsed && typeof parsed === 'object') {
        invNumEl.textContent = parsed.invoice_number || parsed.invoiceNum || parsed.invoice_number_raw || parsed.invoice || "—";
        invDateEl.textContent = parsed.invoice_date || parsed.date || "—";
        invTotalEl.textContent = parsed.total_amount || parsed.total || parsed.amount || "—";
      } else {
        // fallback heuristics: inspect json.content or json.raw_text
        const sourceText = (json.content || json.raw_text || json.text || "") + "";
        invNumEl.textContent = findPattern(sourceText, /\b(?:Invoice\s*(?:Number|No\.?)\s*[#:\-]?\s*)([A-Z0-9\-\/]+)/i) || "—";
        invDateEl.textContent = findPattern(sourceText, /Invoice\s*Date[:\s]*([0-9]{1,2}[-\/.][0-9]{1,2}[-\/.][0-9]{2,4})/i) || "—";
        invTotalEl.textContent = findPattern(sourceText, /(Grand\s*Total|Total\s*Due|Total)[:\s]*([₹$£€]?\s*[0-9,]+(?:\.[0-9]{2})?)/i) || "—";
      }

      // Now animate AI typing of raw content (line-by-line)
      const raw = (json.content || json.raw_text || json.text || json.llm_output_text || "") + "";
      startTyping(raw || "No raw content returned");

      // Prepare JSON download and copy
      const blob = new Blob([JSON.stringify(json, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      downloadJson.href = url;
      copyBtn.onclick = () => { navigator.clipboard.writeText(JSON.stringify(json, null, 2)).then(()=> alert("JSON copied to clipboard")); };
    }

    /* ===== Typing (line-by-line) ===== */
    let typingHandle = null;
    function startTyping(text){
      if (typingHandle) { clearTimeout(typingHandle); typingHandle = null; }
      // split into logical lines (preserve paragraphs)
      const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
      aiPreview.textContent = "";
      let i = 0;
      const typeNextLine = () => {
        if (i >= lines.length) {
          // finished typing: show final JSON below after small pause
          typingHandle = setTimeout(() => {
            // nothing else; final raw already in result pre
          }, 300);
          return;
        }
        const line = lines[i];
        typeLine(line, 0, () => {
          aiPreview.appendChild(document.createElement('br'));
          i++;
          typingHandle = setTimeout(typeNextLine, 220); // line gap
        });
      };
      typeNextLine();
    }

    // type a single line with variable speed (simulate AI)
    function typeLine(line, pos, cb){
      if (pos >= line.length) return cb();
      const chunkSize = Math.max(1, Math.round(Math.random()*2.2)); // variable
      aiPreview.textContent += line.slice(pos, pos + chunkSize);
      const delay = 8 + Math.random()*18; // ms per chunk
      setTimeout(() => typeLine(line, pos + chunkSize, cb), delay);
    }

    /* ===== Utilities ===== */
    function findPattern(text, re){
      if (!text) return null;
      const m = text.match(re);
      if (!m) return null;
      return m[2] || m[1] || m[0];
    }

    /* ===== Theme toggle logic (fixed colors) ===== */
    themeToggle.addEventListener('click', () => {
      document.documentElement.classList.toggle('light');
      // Ensure text contrast is OK after toggling: update colors that rely on theme implicitly handled by CSS variables
    });

    /* ===== Helpful console guidance ===== */
    console.info("Invoice Extractor frontend loaded. Backend endpoint:", BACKEND_URL);
    console.info("If you see 'Failed to fetch' or CORS errors: ensure your backend adds Access-Control-Allow-Origin header for this frontend origin.");
  </script>
</body>
</html>
